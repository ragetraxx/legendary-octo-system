name: Rage Music PH Live Stream

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *" # Runs every 30 minutes

jobs:
  stream:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸš€ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ›  Install FFmpeg
      run: |
        sudo apt update
        sudo apt install -y ffmpeg

    - name: ðŸŽµ Start Streaming
      run: |
        echo "ðŸš€ Starting FFmpeg stream..."

        # Create initial text files for title and artist
        echo "Loading..." > title.txt
        echo "Rage Music PH" > artist.txt

        # Start metadata update loop in the background
        while true; do
          METADATA=$(ffprobe -loglevel error -show_entries format_tags=StreamTitle -of default=noprint_wrappers=1 "https://stream.zeno.fm/q1n2wyfs7x8uv")
          
          # Extract artist and title
          SONG_TITLE=$(echo "$METADATA" | sed 's/StreamTitle=//' | cut -d '-' -f2- | xargs)
          ARTIST=$(echo "$METADATA" | sed 's/StreamTitle=//' | cut -d '-' -f1 | xargs)

          # Update text files
          echo "$SONG_TITLE" > title.txt
          echo "$ARTIST" > artist.txt

          sleep 5  # Update every 5 seconds
        done &

        # Start FFmpeg stream
        ffmpeg -re -i "https://stream.zeno.fm/q1n2wyfs7x8uv" \
        -i logo.png \
        -filter_complex "[0:a]asplit[a1][a2]; \
                         [a1]showcqt=s=1280x200:fps=20:count=8:fullhd=1:bar_g=3:sono_g=0.8[visual]; \
                         [a2]anull[audio]; \
                         [visual]pad=1280:720:0:520:color=black[visual_bg]; \
                         [visual_bg][1:v]overlay=W-w-20:20[bg]; \
                         [bg]drawtext=textfile=title.txt:fontsize=30:fontcolor=white:fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:x=10:y=10[title]; \
                         [title]drawtext=textfile=artist.txt:fontsize=26:fontcolor=white:fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=10:y=50[final]" \
        -map "[final]" -map "[audio]" \
        -c:v libx264 -tune stillimage -b:v 1200k -maxrate 1200k -bufsize 1200k -g 50 -pix_fmt yuv420p \
        -c:a aac -b:a 128k -ar 44100 \
        -f flv "rtmp://ssh101.bozztv.com:1935/ssh101/ragemusicph" \
        -loglevel verbose
